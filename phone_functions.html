<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºåŠŸèƒ½å‰ç«¯ - åŠ¨æ€é€šè®¯å½•</title>
    <style>
        /* ===== å‘½åç©ºé—´éš”ç¦» - ä½¿ç”¨pf-å‰ç¼€ ===== */
        /* é‡ç½®åŸºç¡€æ ·å¼ä»¥é€‚åº”SillyTaverné™åˆ¶ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            background: transparent;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            color: #333;
        }

        /* æ‚¬æµ®çƒæ ·å¼ - å›ºå®šåœ¨å³ä¸‹è§’ */
        .pf-floating-ball {
            position: fixed;
            bottom: 70px; /* åœ¨æ¶ˆæ¯æ ä¸Šæ–¹ */
            right: 10px;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(103, 126, 234, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .pf-floating-ball:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(103, 126, 234, 0.7);
        }

        .pf-floating-ball-icon {
            color: white;
            font-size: 22px;
            font-weight: bold;
        }

        /* å±•å¼€æ–¹å‘é€‰æ‹©å™¨ */
        .pf-expand-direction {
            position: fixed;
            bottom: 125px; /* åœ¨æ‚¬æµ®çƒä¸Šæ–¹ */
            right: 10px;
            width: 48px;
            height: 32px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 4px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .pf-expand-direction.show {
            opacity: 1;
            pointer-events: auto;
        }

        .pf-direction-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 12px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .pf-direction-btn:hover {
            background: #667eea;
            color: white;
        }

        .pf-direction-btn.active {
            background: #667eea;
            color: white;
        }

        /* æ‰‹æœºåŠŸèƒ½å®¹å™¨ - è‡ªé€‚åº”å°ºå¯¸ */
        .pf-phone-container {
            position: fixed;
            right: 10px;
            width: calc(100% - 20px);
            max-width: 400px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* é»˜è®¤å‘ä¸Šå±•å¼€ */
        .pf-phone-container.expand-up {
            bottom: 70px; /* ä»æ‚¬æµ®çƒä¸Šæ–¹å±•å¼€ */
            height: auto; /* è‡ªé€‚åº”é«˜åº¦ */
            max-height: calc(100vh - 150px); /* æœ€å¤§é«˜åº¦é™åˆ¶ */
        }

        /* å‘ä¸‹å±•å¼€æ ·å¼ */
        .pf-phone-container.expand-down {
            top: 70px; /* ä»æ‚¬æµ®çƒä¸‹æ–¹å±•å¼€ */
            height: auto;
            max-height: calc(100vh - 150px);
        }

        /* å…¨å±æ¨¡å¼ */
        .pf-phone-container.expand-full {
            top: 10px;
            right: 10px;
            left: 10px;
            bottom: 10px;
            width: auto;
            max-width: none;
            max-height: none;
            border-radius: 16px;
        }

        .pf-phone-header {
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pf-phone-title {
            font-size: 15px;
            font-weight: 600;
        }

        .pf-phone-header-controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .pf-phone-close, .pf-phone-sync, .pf-phone-fullscreen {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .pf-phone-close:hover, .pf-phone-sync:hover, .pf-phone-fullscreen:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .pf-phone-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.05);
            padding: 4px;
            margin: 0 12px 8px;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .pf-tab-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background: transparent;
            color: #666;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            white-space: nowrap;
        }

        .pf-tab-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .pf-tabs-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 300px; /* æœ€å°é«˜åº¦ç¡®ä¿å†…å®¹å¯è§ */
        }

        .pf-tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: none;
            height: 100%;
        }

        .pf-tab-content.active {
            display: block;
        }

        /* åœ°å›¾æ ·å¼ */
        .pf-map-container {
            font-family: 'Arial', sans-serif;
        }

        .pf-location-item {
            margin: 5px 0;
            padding-left: 16px;
            position: relative;
            line-height: 1.4;
            font-size: 13px;
        }

        .pf-location-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 8px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #667eea;
        }

        .pf-location-item.main {
            font-weight: bold;
            color: #333;
            margin-top: 8px;
            padding-left: 0;
        }

        .pf-location-item.main::before {
            display: none;
        }

        .pf-location-item.sub {
            color: #666;
            padding-left: 20px;
        }

        .pf-location-item.subsub {
            color: #888;
            padding-left: 32px;
            font-size: 12px;
        }

        /* é€šè®¯å½•æ ·å¼ */
        .pf-contact-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pf-contact-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .pf-contact-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.2);
        }

        .pf-contact-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
            font-size: 16px;
            flex-shrink: 0;
        }

        .pf-contact-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .pf-contact-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pf-contact-desc {
            font-size: 11px;
            color: #666;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pf-contact-stats {
            font-size: 10px;
            margin-top: 4px;
            color: #888;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .pf-stat-item {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .pf-contact-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .pf-action-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.05);
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .pf-action-btn:hover {
            background: #667eea;
            color: white;
        }

        /* çŸ­ä¿¡æ ·å¼ */
        .pf-message-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .pf-message-selector {
            margin-bottom: 10px;
        }

        .pf-message-selector select {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: white;
            font-size: 13px;
            color: #333;
        }

        .pf-message-history {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            min-height: 150px;
        }

        .pf-message-input {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .pf-message-input textarea {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            resize: none;
            font-size: 13px;
            min-height: 40px;
            max-height: 100px;
            font-family: inherit;
        }

        .pf-send-btn {
            align-self: flex-end;
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 13px;
            height: fit-content;
        }

        .pf-send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .pf-message-bubble {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 8px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 13px;
        }

        .pf-message-sent {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .pf-message-received {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
        }

        .pf-message-system {
            background: rgba(255, 193, 7, 0.1);
            color: #666;
            font-style: italic;
            max-width: 100%;
            text-align: center;
            font-size: 11px;
        }

        .pf-message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-bottom: 3px;
        }

        /* é€šçŸ¥æ ·å¼ */
        .pf-notification {
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 16px;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            animation: pf-slideIn 0.3s ease-out;
            max-width: 300px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-height: 600px) {
            .pf-phone-container {
                max-height: calc(100vh - 100px);
            }
            
            .pf-phone-header {
                padding: 10px 14px;
            }
            
            .pf-tab-content {
                padding: 10px;
            }
            
            .pf-tabs-content {
                min-height: 250px;
            }
        }

        @media (max-width: 400px) {
            .pf-phone-container {
                right: 5px;
                left: 5px;
                width: calc(100% - 10px);
            }
            
            .pf-floating-ball {
                bottom: 60px;
                right: 5px;
            }
            
            .pf-expand-direction {
                bottom: 115px;
                right: 5px;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes pf-slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pf-slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pf-slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pf-phone-container.show {
            display: flex;
        }

        .pf-phone-container.expand-up.show {
            animation: pf-slideInUp 0.3s ease-out;
        }

        .pf-phone-container.expand-down.show {
            animation: pf-slideInDown 0.3s ease-out;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .pf-status-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .pf-status-online {
            background: #4caf50;
        }

        .pf-status-offline {
            background: #9e9e9e;
        }

        .pf-status-busy {
            background: #f44336;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .pf-tab-content::-webkit-scrollbar {
            width: 6px;
        }

        .pf-tab-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .pf-tab-content::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }

        .pf-tab-content::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        /* è°ƒæ•´SillyTavernå…¼å®¹æ€§ */
        .main-content, .mes {
            transition: margin-bottom 0.3s ease;
        }

        .pf-phone-container.show + .main-content {
            margin-bottom: 100px;
        }
    </style>
</head>
<body>
<!-- æ‚¬æµ®çƒ -->
<div class="pf-floating-ball" id="pfFloatingBall" title="æ‰“å¼€æ‰‹æœºåŠŸèƒ½">
    <div class="pf-floating-ball-icon">ğŸ“±</div>
</div>

<!-- å±•å¼€æ–¹å‘é€‰æ‹©å™¨ -->
<div class="pf-expand-direction" id="pfExpandDirection">
    <button class="pf-direction-btn" data-direction="up" title="å‘ä¸Šå±•å¼€">â†‘</button>
    <button class="pf-direction-btn" data-direction="down" title="å‘ä¸‹å±•å¼€">â†“</button>
</div>

<!-- æ‰‹æœºåŠŸèƒ½ç•Œé¢ -->
<div class="pf-phone-container expand-up" id="pfPhoneContainer">
    <div class="pf-phone-header">
        <div class="pf-phone-title">æ‰‹æœºåŠŸèƒ½</div>
        <div class="pf-phone-header-controls">
            <button class="pf-phone-sync" id="pfSyncBtn" title="åŒæ­¥è”ç³»äºº">â†»</button>
            <button class="pf-phone-fullscreen" id="pfFullscreenBtn" title="å…¨å±æ¨¡å¼">â›¶</button>
            <button class="pf-phone-close" id="pfCloseBtn" title="å…³é—­">Ã—</button>
        </div>
    </div>
    
    <!-- é€‰é¡¹å¡ -->
    <div class="pf-phone-tabs">
        <button class="pf-tab-btn active" data-tab="map" title="æŸ¥çœ‹åœ°å›¾">ğŸ—ºï¸ åœ°å›¾</button>
        <button class="pf-tab-btn" data-tab="contacts" title="æŸ¥çœ‹é€šè®¯å½•">ğŸ‘¥ é€šè®¯å½•</button>
        <button class="pf-tab-btn" data-tab="messages" title="å‘é€çŸ­ä¿¡">ğŸ’¬ çŸ­ä¿¡</button>
    </div>
    
    <div class="pf-tabs-content">
        <!-- åœ°å›¾é€‰é¡¹å¡ -->
        <div class="pf-tab-content active" id="pfTabMap">
            <div class="pf-map-container">
                <div class="pf-location-item main">ä¸œäº¬æ•´ä½“ä½ç½®å…³ç³»</div>
                <div class="pf-location-item main">è¥¿åŒ—æ–¹å‘</div>
                <div class="pf-location-item sub">â”œâ”€ æ‰å¹¶åŒºï¼ˆæ•…äº‹ä¸»è¦èˆå°ï¼‰</div>
                <div class="pf-location-item subsub">â”‚   â”œâ”€ é«˜å††å¯ºï¼ˆä¸»è§’ã€ä¼Šè‰é›…ã€ç¾æ¸¸ã€å…‹æ´›ä¼Šã€å­¦æ ¡ï¼‰</div>
                <div class="pf-location-item subsub">â”‚   â”œâ”€ é˜¿ä½è°·ï¼ˆçŠ¬å†¢å¤ç¾ï¼‰</div>
                <div class="pf-location-item subsub">â”‚   â””â”€ è»æ´¼ï¼ˆå‘¨è¾¹å•†ä¸šåŒºï¼‰</div>
                <div class="pf-location-item sub">â”œâ”€ ä¸­é‡åŒºï¼ˆé˜¿å®…å›ï¼‰</div>
                <div class="pf-location-item sub">â”œâ”€ æ–°å®¿åŒºï¼ˆç¹åå•†ä¸šåŒºï¼Œè½¬è½¦æ¢çº½ï¼‰</div>
                <div class="pf-location-item sub">â”œâ”€ æ–‡äº¬åŒºï¼ˆæœˆå’æ·±é›ªï¼‰</div>
                <div class="pf-location-item sub">â””â”€ æ¸¯åŒºï¼ˆè¥¿å›­å¯ºçˆ±ä¸½èï¼‰</div>
                
                <!-- äº¤äº’æŒ‰é’® -->
                <div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                    <button class="pf-action-btn" id="pfSearchLocation" title="æœç´¢ä½ç½®">
                        <span style="font-size: 16px;">ğŸ”</span>
                    </button>
                    <button class="pf-action-btn" id="pfGetDirections" title="è·å–è·¯çº¿">
                        <span style="font-size: 16px;">ğŸ—ºï¸</span>
                    </button>
                    <button class="pf-action-btn" id="pfCurrentLocation" title="å½“å‰ä½ç½®">
                        <span style="font-size: 16px;">ğŸ“</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- é€šè®¯å½•é€‰é¡¹å¡ -->
        <div class="pf-tab-content" id="pfTabContacts">
            <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 12px; color: #666;">
                    å…± <span id="pfContactCount">0</span> ä¸ªè”ç³»äºº
                </div>
                <div style="display: flex; gap: 6px;">
                    <button class="pf-action-btn" id="pfRefreshContacts" title="åˆ·æ–°" style="font-size: 13px;">â†»</button>
                    <button class="pf-action-btn" id="pfAddContact" title="æ·»åŠ è”ç³»äºº" style="font-size: 13px;">ï¼‹</button>
                </div>
            </div>
            
            <div class="pf-contact-list" id="pfContactList">
                <div style="text-align: center; color: #999; padding: 40px 0;">
                    æ­£åœ¨åŠ è½½è”ç³»äºº...
                </div>
            </div>
        </div>
        
        <!-- çŸ­ä¿¡é€‰é¡¹å¡ -->
        <div class="pf-tab-content" id="pfTabMessages">
            <div class="pf-message-container">
                <div class="pf-message-selector">
                    <select id="pfMessageTo">
                        <option value="">é€‰æ‹©è”ç³»äºº...</option>
                    </select>
                </div>
                
                <div class="pf-message-history" id="pfMessageHistory">
                    <div style="text-align: center; color: #999; padding: 40px 0;">
                        é€‰æ‹©è”ç³»äººå¼€å§‹èŠå¤©
                    </div>
                </div>
                
                <div class="pf-message-input">
                    <textarea id="pfMessageInput" placeholder="è¾“å…¥çŸ­ä¿¡å†…å®¹..."></textarea>
                    <button class="pf-send-btn" id="pfSendMessage">å‘é€</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ===== ç®€åŒ–ç‰ˆPhoneFunctionsç±» - ä¸“ä¸ºSillyTavernä¼˜åŒ– =====
class PhoneFunctions {
    constructor() {
        this.isOpen = false;
        this.currentTab = 'map';
        this.expandDirection = 'up'; // é»˜è®¤å‘ä¸Šå±•å¼€
        this.isFullscreen = false;
        this.contacts = [];
        this.messages = {};
        this.currentChatContact = null;
        
        this.init();
    }
    
    async init() {
        this.bindEvents();
        await this.loadContacts();
        this.loadMessageHistory();
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½åå¥½è®¾ç½®
        this.loadPreferences();
        
        console.log('æ‰‹æœºåŠŸèƒ½å‰ç«¯åˆå§‹åŒ–å®Œæˆ - SillyTavernä¼˜åŒ–ç‰ˆ');
        this.showNotification('æ‰‹æœºåŠŸèƒ½å·²åŠ è½½', 'info');
    }
    
    bindEvents() {
        // æ‚¬æµ®çƒç‚¹å‡»
        document.getElementById('pfFloatingBall').addEventListener('click', (e) => {
            this.togglePhone();
            e.stopPropagation();
        });
        
        // æ‚¬æµ®çƒé•¿æŒ‰æ˜¾ç¤ºæ–¹å‘é€‰æ‹©
        let longPressTimer;
        const floatingBall = document.getElementById('pfFloatingBall');
        
        floatingBall.addEventListener('mousedown', () => {
            longPressTimer = setTimeout(() => {
                document.getElementById('pfExpandDirection').classList.add('show');
            }, 800);
        });
        
        floatingBall.addEventListener('mouseup', () => {
            clearTimeout(longPressTimer);
        });
        
        floatingBall.addEventListener('mouseleave', () => {
            clearTimeout(longPressTimer);
        });
        
        floatingBall.addEventListener('touchstart', () => {
            longPressTimer = setTimeout(() => {
                document.getElementById('pfExpandDirection').classList.add('show');
            }, 800);
        });
        
        floatingBall.addEventListener('touchend', () => {
            clearTimeout(longPressTimer);
        });
        
        // æ–¹å‘é€‰æ‹©æŒ‰é’®
        document.querySelectorAll('.pf-direction-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const direction = e.target.dataset.direction;
                this.setExpandDirection(direction);
                document.getElementById('pfExpandDirection').classList.remove('show');
            });
        });
        
        // å…³é—­æŒ‰é’®
        document.getElementById('pfCloseBtn').addEventListener('click', (e) => {
            this.closePhone();
            e.stopPropagation();
        });
        
        // åŒæ­¥æŒ‰é’®
        document.getElementById('pfSyncBtn').addEventListener('click', async (e) => {
            e.stopPropagation();
            await this.loadContacts();
        });
        
        // å…¨å±æŒ‰é’®
        document.getElementById('pfFullscreenBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleFullscreen();
        });
        
        // åˆ·æ–°è”ç³»äººæŒ‰é’®
        document.getElementById('pfRefreshContacts')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            await this.loadContacts();
        });
        
        // é€‰é¡¹å¡åˆ‡æ¢
        document.querySelectorAll('.pf-tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tab = e.target.dataset.tab;
                this.switchTab(tab);
            });
        });
        
        // åœ°å›¾åŠŸèƒ½æŒ‰é’®
        document.getElementById('pfSearchLocation')?.addEventListener('click', () => {
            this.sendMessageToAI('æœç´¢å½“å‰ä½ç½®é™„è¿‘çš„åœ°ç‚¹');
        });
        
        document.getElementById('pfGetDirections')?.addEventListener('click', () => {
            this.sendMessageToAI('è·å–ä»å½“å‰ä½ç½®åˆ°ç›®çš„åœ°çš„è·¯çº¿');
        });
        
        document.getElementById('pfCurrentLocation')?.addEventListener('click', () => {
            this.sendMessageToAI('å‘Šè¯‰æˆ‘ç°åœ¨åœ¨å“ªé‡Œï¼Œå‘¨å›´æœ‰ä»€ä¹ˆ');
        });
        
        // å‘é€çŸ­ä¿¡
        document.getElementById('pfSendMessage').addEventListener('click', () => {
            this.sendMessage();
        });
        
        // çŸ­ä¿¡è¾“å…¥æ¡†å›è½¦å‘é€
        document.getElementById('pfMessageInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        // è”ç³»äººé€‰æ‹©å˜åŒ–
        document.getElementById('pfMessageTo').addEventListener('change', (e) => {
            const contactId = e.target.value;
            if (contactId) {
                const contact = this.contacts.find(c => c.id === contactId);
                if (contact) {
                    this.currentChatContact = contact;
                    this.loadChatHistory(contactId);
                }
            } else {
                this.currentChatContact = null;
                this.clearChatHistory();
            }
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        document.addEventListener('click', (e) => {
            const phoneContainer = document.getElementById('pfPhoneContainer');
            const floatingBall = document.getElementById('pfFloatingBall');
            const expandDirection = document.getElementById('pfExpandDirection');
            
            if (this.isOpen && 
                !phoneContainer.contains(e.target) && 
                !floatingBall.contains(e.target)) {
                this.closePhone();
            }
            
            // ç‚¹å‡»å¤–éƒ¨éšè—æ–¹å‘é€‰æ‹©å™¨
            if (expandDirection.classList.contains('show') &&
                !floatingBall.contains(e.target) &&
                !expandDirection.contains(e.target)) {
                expandDirection.classList.remove('show');
            }
        });
        
        // é˜²æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶å®¹å™¨
        document.getElementById('pfPhoneContainer')?.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´
        window.addEventListener('resize', () => {
            if (this.isOpen) {
                this.adjustContainerSize();
            }
        });
    }
    
    loadPreferences() {
        try {
            const savedDirection = localStorage.getItem('pf-expand-direction');
            if (savedDirection) {
                this.setExpandDirection(savedDirection);
            }
            
            const savedFullscreen = localStorage.getItem('pf-fullscreen');
            if (savedFullscreen === 'true') {
                this.isFullscreen = true;
                this.updateFullscreenButton();
            }
        } catch (e) {
            console.warn('æ— æ³•åŠ è½½åå¥½è®¾ç½®:', e);
        }
    }
    
    savePreferences() {
        try {
            localStorage.setItem('pf-expand-direction', this.expandDirection);
            localStorage.setItem('pf-fullscreen', this.isFullscreen.toString());
        } catch (e) {
            console.warn('æ— æ³•ä¿å­˜åå¥½è®¾ç½®:', e);
        }
    }
    
    setExpandDirection(direction) {
        this.expandDirection = direction;
        const container = document.getElementById('pfPhoneContainer');
        
        // ç§»é™¤æ‰€æœ‰æ–¹å‘ç±»
        container.classList.remove('expand-up', 'expand-down', 'expand-full');
        
        // æ·»åŠ æ–°æ–¹å‘ç±»
        container.classList.add(`expand-${direction}`);
        
        // æ›´æ–°æ–¹å‘æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.pf-direction-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.direction === direction);
        });
        
        this.savePreferences();
    }
    
    toggleFullscreen() {
        this.isFullscreen = !this.isFullscreen;
        const container = document.getElementById('pfPhoneContainer');
        
        if (this.isFullscreen) {
            container.classList.remove('expand-up', 'expand-down');
            container.classList.add('expand-full');
        } else {
            container.classList.remove('expand-full');
            container.classList.add(`expand-${this.expandDirection}`);
        }
        
        this.updateFullscreenButton();
        this.savePreferences();
    }
    
    updateFullscreenButton() {
        const fullscreenBtn = document.getElementById('pfFullscreenBtn');
        fullscreenBtn.innerHTML = this.isFullscreen ? 'â›¶' : 'â›¶';
        fullscreenBtn.title = this.isFullscreen ? 'é€€å‡ºå…¨å±' : 'å…¨å±æ¨¡å¼';
    }
    
    togglePhone() {
        const container = document.getElementById('pfPhoneContainer');
        this.isOpen = !this.isOpen;
        
        if (this.isOpen) {
            container.classList.add('show');
            this.adjustContainerSize();
            // åˆ·æ–°æ•°æ®
            this.updateContactList();
            this.updateMessageContacts();
            // æ›´æ–°è”ç³»äººæ•°é‡
            document.getElementById('pfContactCount').textContent = this.contacts.length;
            
            // è°ƒæ•´SillyTavernç•Œé¢
            this.adjustSillyTavernUI(true);
        } else {
            container.classList.remove('show');
            // æ¢å¤SillyTavernç•Œé¢
            this.adjustSillyTavernUI(false);
        }
    }
    
    adjustContainerSize() {
        const container = document.getElementById('pfPhoneContainer');
        const viewportHeight = window.innerHeight;
        
        if (this.isFullscreen) {
            // å…¨å±æ¨¡å¼ä¸‹ä½¿ç”¨å›ºå®šé«˜åº¦
            container.style.height = 'auto';
        } else {
            // éå…¨å±æ¨¡å¼ä¸‹æ ¹æ®æ–¹å‘è°ƒæ•´
            if (this.expandDirection === 'up') {
                container.style.maxHeight = `calc(${viewportHeight}px - 150px)`;
            } else {
                container.style.maxHeight = `calc(${viewportHeight}px - 150px)`;
            }
        }
    }
    
    adjustSillyTavernUI(showPhone) {
        // å°è¯•è°ƒæ•´SillyTavernçš„ç•Œé¢ä»¥é¿å…é®æŒ¡
        try {
            const messageArea = document.querySelector('.mes');
            const mainContent = document.querySelector('.main-content');
            
            if (showPhone) {
                if (messageArea) {
                    messageArea.style.marginBottom = '100px';
                }
                if (mainContent) {
                    mainContent.style.marginBottom = '100px';
                }
            } else {
                if (messageArea) {
                    messageArea.style.marginBottom = '';
                }
                if (mainContent) {
                    mainContent.style.marginBottom = '';
                }
            }
        } catch (e) {
            console.log('æ— æ³•è°ƒæ•´SillyTavernç•Œé¢:', e);
        }
    }
    
    closePhone() {
        this.isOpen = false;
        document.getElementById('pfPhoneContainer').classList.remove('show');
        this.adjustSillyTavernUI(false);
    }
    
    switchTab(tab) {
        this.currentTab = tab;
        
        // æ›´æ–°é€‰é¡¹å¡æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.pf-tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tab);
        });
        
        // æ›´æ–°é€‰é¡¹å¡å†…å®¹
        document.querySelectorAll('.pf-tab-content').forEach(content => {
            const tabName = content.id.replace('pfTab', '');
            content.classList.toggle('active', tabName.toLowerCase() === tab);
        });
        
        // åˆ‡æ¢æ—¶åŠ è½½å¯¹åº”æ•°æ®
        if (tab === 'contacts') {
            this.updateContactList();
        } else if (tab === 'messages') {
            this.updateMessageContacts();
        }
    }
    
    async loadContacts() {
        try {
            // å°è¯•ä»MVUç³»ç»Ÿè·å–æ•°æ®
            if (typeof window.Mvu !== 'undefined') {
                await this.loadContactsFromMvu();
            } else {
                // ä½¿ç”¨é»˜è®¤æ•°æ®
                this.loadDefaultContacts();
            }
            
            this.updateContactList();
            this.updateMessageContacts();
            this.showNotification(`å·²åŠ è½½${this.contacts.length}ä¸ªè”ç³»äºº`, 'success');
            
        } catch (error) {
            console.error('åŠ è½½è”ç³»äººå¤±è´¥:', error);
            this.loadDefaultContacts();
            this.showNotification('ä½¿ç”¨é»˜è®¤é€šè®¯å½•', 'warning');
        }
    }
    
    async loadContactsFromMvu() {
        try {
            // ç­‰å¾…MVUæ¡†æ¶åˆå§‹åŒ–
            if (typeof window.TavernHelper !== 'undefined') {
                await window.TavernHelper.waitGlobalInitialized('Mvu');
            }
            
            let mvuData;
            if (typeof window.Mvu !== 'undefined' && window.Mvu.getMvuData) {
                mvuData = window.Mvu.getMvuData({ type: 'chat' });
            }
            
            if (mvuData?.stat_data?.è§’è‰²) {
                this.contacts = [];
                const roles = mvuData.stat_data.è§’è‰²;
                
                Object.entries(roles).forEach(([roleName, roleData], index) => {
                    if (typeof roleData !== 'object' || roleData === null) return;
                    
                    const contact = {
                        id: this.generateContactId(roleName, index),
                        name: roleName,
                        desc: roleData.æè¿° || roleData.å¤‡æ³¨ || `${roleName} - è§’è‰²`,
                        avatar: roleName.charAt(0),
                        phone: this.generatePhoneNumber(index),
                        status: this.getContactStatus(roleData),
                        lastContact: this.generateLastContactTime(),
                        mvuData: { ...roleData }
                    };
                    
                    // ç¡®ä¿åŸºç¡€å±æ€§å­˜åœ¨
                    ['å¥½æ„Ÿåº¦', 'è­¦æˆ’åº¦', 'æœä»åº¦', 'æ€§æ¬²'].forEach(prop => {
                        if (!contact.mvuData[prop]) contact.mvuData[prop] = 0;
                    });
                    
                    this.contacts.push(contact);
                });
                
                console.log(`ä»MVUåŠ è½½äº†${this.contacts.length}ä¸ªè”ç³»äºº`);
            } else {
                this.loadDefaultContacts();
            }
            
        } catch (error) {
            console.warn('MVUåŠ è½½å¤±è´¥:', error);
            this.loadDefaultContacts();
        }
    }
    
    loadDefaultContacts() {
        this.contacts = [
            {
                id: 'yukino',
                name: 'æœˆå’æ·±é›ª',
                desc: 'ç­çº§å§”å‘˜é•¿ï¼Œé»‘å‘æ¸…æ¥šç³»ç¾å°‘å¥³',
                avatar: 'é›ª',
                phone: '080-1111-2222',
                status: 'online',
                lastContact: '2å°æ—¶å‰',
                mvuData: { å¥½æ„Ÿåº¦: 50, è­¦æˆ’åº¦: 10, æœä»åº¦: 30, æ€§æ¬²: 5 }
            },
            {
                id: 'arisa',
                name: 'è¥¿å›­å¯ºçˆ±ä¸½è',
                desc: 'è¥¿å›­å¯ºè´¢å›¢åƒé‡‘ï¼Œé‡‘å‘å·¨ä¹³å¤§å°å§',
                avatar: 'çˆ±',
                phone: '080-2222-3333',
                status: 'online',
                lastContact: '1å¤©å‰',
                mvuData: { å¥½æ„Ÿåº¦: 70, è­¦æˆ’åº¦: 20, æœä»åº¦: 10, æ€§æ¬²: 15 }
            },
            {
                id: 'natsumi',
                name: 'çŠ¬å†¢å¤ç¾',
                desc: 'ç”°å¾„éƒ¨ç‹ç‰Œï¼ŒçŸ­å‘å…ƒæ°”å‡å°å­',
                avatar: 'å¤',
                phone: '080-3333-4444',
                status: 'offline',
                lastContact: 'åˆšåˆš',
                mvuData: { å¥½æ„Ÿåº¦: 80, è­¦æˆ’åº¦: 5, æœä»åº¦: 40, æ€§æ¬²: 10 }
            },
            {
                id: 'otaku',
                name: 'é˜¿å®…å›',
                desc: 'çˆ±ä¸½èçš„é’æ¢…ç«¹é©¬ï¼ŒäºŒæ¬¡å…ƒçˆ±å¥½è€…',
                avatar: 'å®…',
                phone: '080-4444-5555',
                status: 'busy',
                lastContact: '3å¤©å‰',
                mvuData: { å¥½æ„Ÿåº¦: 40, è­¦æˆ’åº¦: 30, æœä»åº¦: 20, æ€§æ¬²: 25 }
            }
        ];
        
        // æ·»åŠ ç³»ç»Ÿè”ç³»äºº
        this.contacts.push({
            id: 'system_info',
            name: 'ç³»ç»Ÿä¿¡æ¯',
            desc: 'æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€å’Œå¸®åŠ©',
            avatar: 'âš™ï¸',
            phone: '080-0000-0000',
            status: 'online',
            lastContact: 'åˆšåˆš',
            mvuData: { ç±»å‹: 'ç³»ç»Ÿ', å¥½æ„Ÿåº¦: 100 }
        });
    }
    
    generateContactId(name, index) {
        const pinyinMap = {
            'æœˆå’æ·±é›ª': 'yukino',
            'è¥¿å›­å¯ºçˆ±ä¸½è': 'arisa',
            'çŠ¬å†¢å¤ç¾': 'natsumi',
            'é˜¿å®…å›': 'otaku'
        };
        
        return pinyinMap[name] || `contact_${index}`;
    }
    
    generatePhoneNumber(index) {
        return `080-1234-${(1000 + index).toString().padStart(4, '0')}`;
    }
    
    getContactStatus(roleData) {
        if (roleData.çŠ¶æ€ === 'åœ¨çº¿' || roleData.status === 'online') return 'online';
        if (roleData.çŠ¶æ€ === 'å¿™ç¢Œ' || roleData.status === 'busy') return 'busy';
        if (roleData.çŠ¶æ€ === 'ç¦»çº¿' || roleData.status === 'offline') return 'offline';
        
        const favorability = roleData.å¥½æ„Ÿåº¦ || 0;
        if (favorability > 50) return 'online';
        if (favorability < 0) return 'busy';
        return 'offline';
    }
    
    generateLastContactTime() {
        const hoursAgo = Math.floor(Math.random() * 72);
        if (hoursAgo < 1) return 'åˆšåˆš';
        if (hoursAgo < 24) return `${hoursAgo}å°æ—¶å‰`;
        return `${Math.floor(hoursAgo / 24)}å¤©å‰`;
    }
    
    updateContactList() {
        const container = document.getElementById('pfContactList');
        const countElement = document.getElementById('pfContactCount');
        
        if (!container) return;
        
        if (countElement) {
            countElement.textContent = this.contacts.length;
        }
        
        if (this.contacts.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; color: #999; padding: 40px 0;">
                    <div style="font-size: 36px; margin-bottom: 12px;">ğŸ“‡</div>
                    <div style="margin-bottom: 8px;">æ²¡æœ‰æ‰¾åˆ°è”ç³»äºº</div>
                    <button id="pfRetryLoad" style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        é‡è¯•åŠ è½½
                    </button>
                </div>
            `;
            
            document.getElementById('pfRetryLoad')?.addEventListener('click', async () => {
                await this.loadContacts();
            });
            
            return;
        }
        
        // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“
        container.innerHTML = '';
        
        // æŒ‰é¦–å­—æ¯æ’åº
        const sortedContacts = [...this.contacts].sort((a, b) => {
            return a.name.localeCompare(b.name, 'zh-CN');
        });
        
        // æ¸²æŸ“è”ç³»äººåˆ—è¡¨
        sortedContacts.forEach(contact => {
            const element = this.createContactElement(contact);
            container.appendChild(element);
        });
    }
    
    createContactElement(contact) {
        const element = document.createElement('div');
        element.className = 'pf-contact-item';
        element.dataset.id = contact.id;
        
        const statusClass = {
            'online': 'pf-status-online',
            'offline': 'pf-status-offline',
            'busy': 'pf-status-busy'
        }[contact.status] || 'pf-status-offline';
        
        const statsHtml = contact.mvuData ? `
            <div class="pf-contact-stats">
                <span class="pf-stat-item" title="å¥½æ„Ÿåº¦">â™¥${contact.mvuData.å¥½æ„Ÿåº¦ || 0}</span>
                <span class="pf-stat-item" title="è­¦æˆ’åº¦">âš ${contact.mvuData.è­¦æˆ’åº¦ || 0}</span>
                <span class="pf-stat-item" title="æœä»åº¦">ğŸ“‹${contact.mvuData.æœä»åº¦ || 0}</span>
                <span class="pf-stat-item" title="æ€§æ¬²">ğŸ”¥${contact.mvuData.æ€§æ¬² || 0}</span>
            </div>
        ` : '';
        
        element.innerHTML = `
            <div class="pf-contact-avatar">${contact.avatar}</div>
            <div class="pf-contact-info">
                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 2px;">
                    <span class="pf-contact-name">${contact.name}</span>
                    <span class="pf-status-indicator ${statusClass}"></span>
                </div>
                <div class="pf-contact-desc">${contact.desc}</div>
                <div style="font-size: 10px; color: #888; margin-top: 2px;">
                    <span>ğŸ“ ${contact.phone}</span>
                    <span style="margin-left: 8px;">ğŸ• ${contact.lastContact}</span>
                </div>
                ${statsHtml}
            </div>
            <div class="pf-contact-actions">
                <button class="pf-action-btn pf-message-btn" title="å‘çŸ­ä¿¡">ğŸ’¬</button>
            </div>
        `;
        
        // ç»‘å®šäº‹ä»¶
        element.addEventListener('click', (e) => {
            if (!e.target.closest('.pf-contact-actions')) {
                this.showContactDetail(contact);
            }
        });
        
        element.querySelector('.pf-message-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            this.openMessageTo(contact);
        });
        
        return element;
    }
    
    showContactDetail(contact) {
        // ç®€åŒ–ç‰ˆè¯¦æƒ…å¼¹çª—
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            animation: pf-slideIn 0.3s ease-out;
        `;
        
        modal.innerHTML = `
            <div style="background: white; width: 90%; max-width: 350px; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative;">
                <div style="padding: 20px;">
                    <div style="text-align: center; margin-bottom: 16px;">
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: inline-flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; margin-bottom: 12px;">
                            ${contact.avatar}
                        </div>
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 4px;">${contact.name}</div>
                        <div style="color: #666; font-size: 12px;">${contact.desc}</div>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.03); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                            <span style="color: #666;">ç”µè¯</span>
                            <span style="font-weight: 500;">${contact.phone}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 13px;">
                            <span style="color: #666;">çŠ¶æ€</span>
                            <span style="font-weight: 500; color: ${contact.status === 'online' ? '#4caf50' : contact.status === 'busy' ? '#f44336' : '#9e9e9e'}">
                                ${contact.status === 'online' ? 'åœ¨çº¿' : contact.status === 'busy' ? 'å¿™ç¢Œ' : 'ç¦»çº¿'}
                            </span>
                        </div>
                    </div>
                    
                    ${contact.mvuData ? `
                    <div style="background: rgba(0,0,0,0.03); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #667eea; font-size: 13px;">è§’è‰²æ•°æ®</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            <div style="background: white; padding: 8px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 11px; color: #666; margin-bottom: 2px;">å¥½æ„Ÿåº¦</div>
                                <div style="font-size: 16px; font-weight: bold; color: #e91e63;">â™¥${contact.mvuData.å¥½æ„Ÿåº¦ || 0}</div>
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 11px; color: #666; margin-bottom: 2px;">è­¦æˆ’åº¦</div>
                                <div style="font-size: 16px; font-weight: bold; color: #ff9800;">âš ${contact.mvuData.è­¦æˆ’åº¦ || 0}</div>
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 11px; color: #666; margin-bottom: 2px;">æœä»åº¦</div>
                                <div style="font-size: 16px; font-weight: bold; color: #2196f3;">ğŸ“‹${contact.mvuData.æœä»åº¦ || 0}</div>
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 11px; color: #666; margin-bottom: 2px;">æ€§æ¬²</div>
                                <div style="font-size: 16px; font-weight: bold; color: #f44336;">ğŸ”¥${contact.mvuData.æ€§æ¬² || 0}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 8px;">
                        <button id="pfDetailMessage" style="flex: 1; padding: 10px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px;">
                            ğŸ’¬ å‘çŸ­ä¿¡
                        </button>
                    </div>
                </div>
                <button id="pfCloseDetail" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.2); border: none; width: 28px; height: 28px; border-radius: 50%; color: white; cursor: pointer; font-size: 18px;">Ã—</button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // ç»‘å®šäº‹ä»¶
        document.getElementById('pfCloseDetail').addEventListener('click', () => {
            modal.remove();
        });
        
        document.getElementById('pfDetailMessage').addEventListener('click', () => {
            this.openMessageTo(contact);
            modal.remove();
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }
    
    updateMessageContacts() {
        const select = document.getElementById('pfMessageTo');
        if (!select) return;
        
        const currentValue = select.value;
        select.innerHTML = '<option value="">é€‰æ‹©è”ç³»äºº...</option>';
        
        const sortedContacts = [...this.contacts].sort((a, b) => {
            return a.name.localeCompare(b.name, 'zh-CN');
        });
        
        sortedContacts.forEach(contact => {
            const option = document.createElement('option');
            option.value = contact.id;
            option.textContent = `${contact.name}`;
            select.appendChild(option);
        });
        
        if (currentValue && this.contacts.some(c => c.id === currentValue)) {
            select.value = currentValue;
        }
    }
    
    openMessageTo(contact) {
        this.switchTab('messages');
        document.getElementById('pfMessageTo').value = contact.id;
        this.currentChatContact = contact;
        this.loadChatHistory(contact.id);
        document.getElementById('pfMessageInput').focus();
    }
    
    sendMessage() {
        const contactId = document.getElementById('pfMessageTo').value;
        const messageText = document.getElementById('pfMessageInput').value.trim();
        
        if (!contactId) {
            this.showNotification('è¯·å…ˆé€‰æ‹©è”ç³»äºº', 'warning');
            return;
        }
        
        if (!messageText) {
            this.showNotification('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'warning');
            return;
        }
        
        const contact = this.contacts.find(c => c.id === contactId);
        if (!contact) {
            this.showNotification('è”ç³»äººä¸å­˜åœ¨', 'error');
            return;
        }
        
        // æ·»åŠ åˆ°æ¶ˆæ¯å†å²
        this.addMessageToHistory(contactId, {
            type: 'sent',
            text: messageText,
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        });
        
        // å‘é€åˆ°AI
        this.sendMessageToAI(`ã€å‘çŸ­ä¿¡ã€‘ç»™${contact.name}å‘é€çŸ­ä¿¡ï¼š${messageText}`);
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('pfMessageInput').value = '';
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        const history = document.getElementById('pfMessageHistory');
        history.scrollTop = history.scrollHeight;
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        this.saveMessageHistory();
    }
    
    addMessageToHistory(contactId, message) {
        const history = document.getElementById('pfMessageHistory');
        
        if (!this.messages[contactId]) {
            this.messages[contactId] = [];
        }
        
        this.messages[contactId].push({
            ...message,
            timestamp: Date.now()
        });
        
        if (this.messages[contactId].length > 100) {
            this.messages[contactId] = this.messages[contactId].slice(-100);
        }
        
        this.renderChatHistory(contactId);
    }
    
    loadChatHistory(contactId) {
        if (!this.messages[contactId]) {
            this.messages[contactId] = [];
        }
        this.renderChatHistory(contactId);
    }
    
    renderChatHistory(contactId) {
        const history = document.getElementById('pfMessageHistory');
        const messages = this.messages[contactId] || [];
        
        history.innerHTML = '';
        
        if (messages.length === 0) {
            history.innerHTML = `
                <div style="text-align: center; color: #999; padding: 40px 0;">
                    <div style="font-size: 36px; margin-bottom: 12px;">ğŸ’¬</div>
                    <div>è¿˜æ²¡æœ‰å’Œ${this.currentChatContact?.name || 'å¯¹æ–¹'}çš„èŠå¤©è®°å½•</div>
                    <div style="font-size: 11px; margin-top: 6px;">å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹å¯¹è¯</div>
                </div>
            `;
            return;
        }
        
        messages.forEach(msg => {
            const messageElement = document.createElement('div');
            
            let bubbleClass = 'pf-message-bubble ';
            if (msg.type === 'sent') {
                bubbleClass += 'pf-message-sent';
            } else if (msg.type === 'system') {
                bubbleClass += 'pf-message-system';
            } else {
                bubbleClass += 'pf-message-received';
            }
            
            messageElement.className = bubbleClass;
            messageElement.innerHTML = `
                <div class="pf-message-time">${msg.time}</div>
                <div>${msg.text}</div>
            `;
            
            history.appendChild(messageElement);
        });
        
        setTimeout(() => {
            history.scrollTop = history.scrollHeight;
        }, 100);
    }
    
    clearChatHistory() {
        const history = document.getElementById('pfMessageHistory');
        history.innerHTML = `
            <div style="text-align: center; color: #999; padding: 40px 0;">
                é€‰æ‹©è”ç³»äººå¼€å§‹èŠå¤©
            </div>
        `;
    }
    
    loadMessageHistory() {
        try {
            const saved = localStorage.getItem('pf-messages-simple');
            if (saved) {
                this.messages = JSON.parse(saved);
            }
        } catch (e) {
            this.messages = {};
        }
    }
    
    saveMessageHistory() {
        try {
            localStorage.setItem('pf-messages-simple', JSON.stringify(this.messages));
        } catch (e) {
            console.warn('æ— æ³•ä¿å­˜æ¶ˆæ¯å†å²:', e);
        }
    }
    
    sendMessageToAI(message) {
        console.log('å‘é€æ¶ˆæ¯åˆ°AI:', message);
        
        try {
            // æ–¹æ³•1: ä½¿ç”¨é…’é¦†åŠ©æ‰‹çš„triggerSlash
            if (typeof window.TavernHelper !== 'undefined' && window.TavernHelper.triggerSlash) {
                window.TavernHelper.triggerSlash(`/say ${message}`);
                return;
            }
            
            // æ–¹æ³•2: å‘é€è‡ªå®šä¹‰äº‹ä»¶
            const event = new CustomEvent('send-user-message', {
                detail: { text: message }
            });
            window.dispatchEvent(event);
            
            // æ·»åŠ åˆ°ç³»ç»Ÿæ¶ˆæ¯ä½œä¸ºå¤‡ç”¨
            if (this.currentChatContact) {
                this.addMessageToHistory(this.currentChatContact.id, {
                    type: 'system',
                    text: `[å·²å‘é€åˆ°AI]: ${message}`,
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                });
            }
            
            this.showNotification('æ¶ˆæ¯å·²å‘é€', 'success');
            
        } catch (error) {
            console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            this.showNotification('å‘é€å¤±è´¥', 'error');
        }
    }
    
    showNotification(message, type = 'info') {
        const colors = {
            'info': '#667eea',
            'success': '#4caf50',
            'warning': '#ff9800',
            'error': '#f44336'
        };
        
        const icon = {
            'info': 'â„¹ï¸',
            'success': 'âœ…',
            'warning': 'âš ï¸',
            'error': 'âŒ'
        }[type] || 'â„¹ï¸';
        
        // ç§»é™¤å·²æœ‰çš„é€šçŸ¥
        const existing = document.querySelectorAll('.pf-notification');
        existing.forEach(el => el.remove());
        
        // åˆ›å»ºæ–°é€šçŸ¥
        const notification = document.createElement('div');
        notification.className = 'pf-notification';
        notification.style.background = colors[type] || colors.info;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 6px;">
                <div style="font-size: 14px;">${icon}</div>
                <div style="font-size: 12px;">${message}</div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            notification.style.animation = 'pf-slideIn 0.3s ease-out reverse forwards';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
}

// ===== å…¨å±€åˆå§‹åŒ– =====
function initializePhoneFunctions() {
    try {
        // ç¡®ä¿ä¸ä¼šé‡å¤åˆå§‹åŒ–
        if (!window.pfInstance) {
            window.pfInstance = new PhoneFunctions();
            console.log('æ‰‹æœºåŠŸèƒ½å‰ç«¯å·²åˆå§‹åŒ– - SillyTavernä¼˜åŒ–ç‰ˆ');
        }
    } catch (error) {
        console.error('æ‰‹æœºåŠŸèƒ½å‰ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: #f44336;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            z-index: 10003;
            max-width: 250px;
            font-size: 11px;
        `;
        errorDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 2px;">æ‰‹æœºåŠŸèƒ½åŠ è½½å¤±è´¥</div>
            <div>${error.message}</div>
        `;
        document.body.appendChild(errorDiv);
        
        setTimeout(() => errorDiv.remove(), 5000);
    }
}

// ç­‰å¾…DOMåŠ è½½å®Œæˆ
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePhoneFunctions);
} else {
    initializePhoneFunctions();
}
</script>
</body>
</html>
